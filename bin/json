#!/bin/sh

#
# To vars if starts with '{' or to json
# Usage:
#   echo "\"{\"foo\":\"1\",\"bar\":\"2\"}\"" | json
#   json "\"{\"foo\":\"1\",\"bar\":\"2\"}\""
#   echo "{\"foo\":\"1\",\"bar\":\"2\"}" | json
#   json "{\"foo\":\"1\",\"bar\":\"2\"}"
#   printf "%s\n" foo 1 bar 2 | json
#   json foo 1 bar 2

help() {
  >&2 cat <<EOF
usage: ${0##*/} <json|var value>
   or: <json|var value> | ${0##*/}

to json or from json to variables

Commands:
   -h, --help   display this help and exit.

Examples:
  echo "\"{\"foo\":\"1\",\"bar\":\"2\"}\"" | ${0##*/}
  ${0##*/} "\"{\"foo\":\"1\",\"bar\":\"2\"}\""
  echo "{\"foo\":\"1\",\"bar\":\"2\"}" | ${0##*/}
  ${0##*/} "{\"foo\":\"1\",\"bar\":\"2\"}"
  printf "%s\n" foo 1 bar 2 | ${0##*/}
  ${0##*/} foo 1 bar 2
EOF
  exit
}

json_to_env() {
  sed -E 's/({|}|")//g' | tr "," "\n" | while IFS=: read -r var value; do
    echo "${var}=${value}"
  done
}

to_json() {
  json="{"
  odd=true
  for arg; do
    json="${json}\"${arg}\""
    if $odd; then
      json="${json}:"; odd=false
    else
      json="${json},"; odd=true
    fi
  done
  echo "${json}" | sed 's/,$/}/'
}
set +x
main() {
  echo=false; json="{"; odd=true
  for arg; do
    case "$arg" in
      '{'*|'"{'*)
        echo "${arg}" | sed -E 's/": "/:/g; s/({|}|")//g' | tr "," "\n" | while IFS=: read -r var value; do
          echo "${var}=${value}"
        done
        ;;
      --help|-h) help ;;
      *)
        echo=true
        json="${json}\"${arg}\""
        if $odd; then
          json="${json}:"; odd=false
        else
          json="${json},"; odd=true
        fi
        ;;
    esac
  done
  ! $echo || echo "${json}" | sed 's/,$/}/'
}

if test -s /dev/stdin; then
  while read -r word; do
    set -- "$@" "${word}"
  done
fi

main "$@"
