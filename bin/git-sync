#!/bin/sh

#
# Syncs a repository

set -eu

[ ! "${1-}" ] || cd "$1"

git fetch --quiet
git fetch --tags --quiet

if git status | grep -q "have diverged"; then
  >&2 echo "${0##*/}: Diverged"
  exit 1
fi
if git status | grep -q "Your branch is behind" && test -n "$(git status --porcelain)"; then
  >&2 echo "${0##*/}: Behind remote & directory is not clean"
  exit 1
fi
if git status | grep -q "Your branch is behind"; then
  git pull --quiet
  git pull --quiet --tags
  exit 0
fi
if test -n "$(git status --porcelain)"; then
  git add -A
  git commit --quiet -a -m "${0##*/}: ${*:-$(git status --short | tr '\n' ' ')}"
fi

git status | grep -q "Your branch is up to date" || { git push --quiet && git push --tags --quiet; }
