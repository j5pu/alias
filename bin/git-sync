#!/bin/sh

#
# Syncs a repository or repositories

set -eu

sync() {
  cd "$1"

  if test -d "$(git rev-parse --show-toplevel)/.gitmodules" && ! $skip; then
    git submodule foreach --recursive "$0 --skip-submodules"
  fi

  git fetch --quiet
  git fetch --tags --quiet

  if git status | grep -q "have diverged"; then
    echo >&2 "${0##*/}: Diverged"
    return 1
  fi
  if git status | grep -q "Your branch is behind" && test -n "$(git status --porcelain)"; then
    echo >&2 "${0##*/}: Behind remote & directory is not clean"
    return 1
  fi
  if git status | grep -q "Your branch is behind"; then
    git pull --quiet
    git pull --quiet --tags
    return 0
  fi
  if test -n "$(git status --porcelain)"; then
    git add -A
    git commit --quiet -a -m "${0##*/}: ${*:-$(git status --short | tr '\n' ' ')}"
  fi

  git status | grep -q "Your branch is up to date" || { git push --quiet && git push --tags --quiet; }
}

main() {
  [ $# -ge 1 ] || set -- .

  skip=false

  for arg; do
    case "$arg" in
      -h|--help) help; exit ;;
      --skip-submodules) skip=true ;;
      *) sync "${arg}" ;;
    esac
  done
}

main "$@"
